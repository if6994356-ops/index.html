import React, { useEffect, useMemo, useState } from "react";

// E-Learning Mini — Single-file React app
// Tailwind CSS assumed to be available in the project.
// You can drop this component into a CRA/Vite + Tailwind project and render <ElearnApp /> in index.jsx.

export default function ElearnApp() {
  // --- Sample data ---
  const sampleCourses = useMemo(
    () => [
      {
        id: "course-1",
        title: "Dasar Pemrograman JavaScript",
        description: "Belajar variabel, fungsi, dan DOM manipulation.",
        lessons: [
          {
            id: "c1-l1",
            title: "Pengenalan JavaScript",
            duration: "06:10",
            content: {
              type: "text",
              text: "JavaScript adalah bahasa pemrograman untuk web...",
            },
          },
          {
            id: "c1-l2",
            title: "Variabel & Tipe Data",
            duration: "08:24",
            content: {
              type: "video",
              src: "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4",
            },
          },
          {
            id: "c1-l3",
            title: "Function & Scope",
            duration: "10:02",
            content: { type: "text", text: "Fungsi adalah blok kode yang bisa dipanggil..." },
          },
        ],
      },
      {
        id: "course-2",
        title: "HTML & CSS untuk Pemula",
        description: "Membuat layout, styling, dan responsive basics.",
        lessons: [
          { id: "c2-l1", title: "Pengenalan HTML", duration: "05:00", content: { type: "text", text: "HTML adalah struktur halaman..." } },
          { id: "c2-l2", title: "Box Model & Flexbox", duration: "09:12", content: { type: "text", text: "Box model terdiri dari margin, border, padding..." } },
        ],
      },
    ],
    []
  );

  // --- App state ---
  const [courses] = useState(sampleCourses);
  const [user, setUser] = useState(() => {
    // simple mock auth from localStorage
    try {
      const raw = localStorage.getItem("el_user");
      return raw ? JSON.parse(raw) : null;
    } catch {
      return null;
    }
  });
  const [view, setView] = useState({ name: "catalog" }); // catalog | course | lesson | profile
  const [selectedCourse, setSelectedCourse] = useState(null);
  const [selectedLesson, setSelectedLesson] = useState(null);
  const [progress, setProgress] = useState(() => {
    try {
      return JSON.parse(localStorage.getItem("el_progress")) || {};
    } catch {
      return {};
    }
  });

  useEffect(() => {
    localStorage.setItem("el_progress", JSON.stringify(progress));
  }, [progress]);

  useEffect(() => {
    if (user) localStorage.setItem("el_user", JSON.stringify(user));
    else localStorage.removeItem("el_user");
  }, [user]);

  // --- helpers ---
  function openCourse(course) {
    setSelectedCourse(course);
    setView({ name: "course" });
  }

  function openLesson(course, lesson) {
    setSelectedCourse(course);
    setSelectedLesson(lesson);
    setView({ name: "lesson" });
  }

  function markLessonComplete(courseId, lessonId) {
    setProgress((p) => {
      const next = { ...p };
      next[courseId] = next[courseId] || {};
      next[courseId][lessonId] = true;
      return next;
    });
  }

  function percentComplete(course) {
    const done = progress[course.id] || {};
    const total = course.lessons.length;
    const completed = Object.keys(done).length;
    return Math.round((completed / total) * 100);
  }

  function signIn(name) {
    setUser({ name });
  }

  function signOut() {
    setUser(null);
  }

  function downloadCertificate(course) {
    // Create a printable certificate in a new window
    const name = user ? user.name : "Nama Peserta";
    const html = `
      <html><head><title>Sertifikat</title>
      <style>
        body{font-family: Inter, ui-sans-serif, system-ui; display:flex; justify-content:center; align-items:center; height:100vh;}
        .card{border:10px solid #111827; padding:40px; width:800px; text-align:center}
        h1{font-size:32px;margin-bottom:0}
        p{font-size:18px}
      </style>
      </head><body>
      <div class="card">
        <h1>Sertifikat Penyelesaian</h1>
        <p>Diberikan kepada</p>
        <h2 style="margin:6px 0">${name}</h2>
        <p>Telah menyelesaikan kursus</p>
        <h3 style="margin:6px 0">${course.title}</h3>
        <p>Tanggal: ${new Date().toLocaleDateString()}</p>
      </div>
      <script>window.print()</script>
      </body></html>
    `;
    const w = window.open("", "_blank");
    if (w) {
      w.document.write(html);
      w.document.close();
    } else {
      alert("Popup diblokir. Izinkan popup atau gunakan fitur print manual.");
    }
  }

  // --- Components ---
  function Header() {
    return (
      <header className="bg-white shadow-sm sticky top-0 z-30">
        <div className="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
          <div className="flex items-center gap-4">
            <div className="text-2xl font-extrabold text-sky-600">E-LearnMini</div>
            <nav className="hidden md:flex gap-3 text-sm text-gray-700">
              <button className="hover:underline" onClick={() => { setView({ name: "catalog" }); setSelectedCourse(null); }}>Katalog</button>
              <button className="hover:underline" onClick={() => setView({ name: "profile" })}>Profil</button>
            </nav>
          </div>
          <div className="flex items-center gap-3">
            {user ? (
              <>
                <span className="text-sm">Halo, <strong>{user.name}</strong></span>
                <button className="px-3 py-1 rounded bg-sky-600 text-white text-sm" onClick={() => signOut()}>Keluar</button>
              </>
            ) : (
              <AuthShort onSignIn={signIn} />
            )}
          </div>
        </div>
      </header>
    );
  }

  function AuthShort({ onSignIn }) {
    const [val, setVal] = useState("");
    return (
      <div className="flex gap-2 items-center">
        <input value={val} onChange={(e) => setVal(e.target.value)} placeholder="Nama kamu" className="px-3 py-1 border rounded text-sm" />
        <button className="px-3 py-1 rounded bg-sky-600 text-white text-sm" onClick={() => { if (val.trim()) onSignIn(val.trim()); else alert("Masukkan nama terlebih dahulu"); }}>Masuk</button>
      </div>
    );
  }

  function Catalog() {
    return (
      <div className="max-w-6xl mx-auto px-4 py-8 grid grid-cols-1 md:grid-cols-2 gap-6">
        {courses.map((c) => (
          <div key={c.id} className="border rounded-lg p-4 shadow-sm bg-white">
            <div className="flex justify-between items-start">
              <div>
                <h3 className="text-lg font-semibold">{c.title}</h3>
                <p className="text-sm text-gray-600 mt-1">{c.description}</p>
              </div>
              <div className="text-right">
                <p className="text-sm text-gray-500">{c.lessons.length} lesson</p>
                <div className="text-xs text-gray-500">{percentComplete(c)}% selesai</div>
              </div>
            </div>

            <div className="mt-4 flex gap-2">
              <button className="px-3 py-1 bg-sky-600 text-white rounded text-sm" onClick={() => openCourse(c)}>Buka</button>
              <button className="px-3 py-1 border rounded text-sm" onClick={() => { setSelectedCourse(c); setView({ name: "course" }); }}>Detail</button>
            </div>
          </div>
        ))}
      </div>
    );
  }

  function CourseView({ course }) {
    if (!course) return <div className="p-8">Pilih kursus dari katalog.</div>;
    return (
      <div className="max-w-5xl mx-auto px-4 py-8">
        <div className="flex justify-between items-center gap-4">
          <div>
            <h2 className="text-2xl font-bold">{course.title}</h2>
            <p className="text-sm text-gray-600">{course.description}</p>
            <div className="mt-2 text-sm">Progress: {percentComplete(course)}%</div>
          </div>
          <div className="flex gap-2">
            <button className="px-3 py-1 bg-green-600 text-white rounded text-sm" onClick={() => openLesson(course, course.lessons[0])}>Mulai</button>
            <button className="px-3 py-1 border rounded text-sm" onClick={() => downloadCertificate(course)}>Sertifikat</button>
          </div>
        </div>

        <div className="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div className="md:col-span-2">
            <div className="bg-white border rounded p-4">
              <h4 className="font-semibold mb-2">Daftar Pelajaran</h4>
              <ol className="space-y-2">
                {course.lessons.map((l) => (
                  <li key={l.id} className="flex justify-between items-center p-2 border rounded">
                    <div>
                      <div className="font-medium">{l.title}</div>
                      <div className="text-xs text-gray-500">Durasi: {l.duration}</div>
                    </div>
                    <div className="flex items-center gap-2">
                      {progress[course.id] && progress[course.id][l.id] && (
                        <span className="text-xs text-green-600">Selesai</span>
                      )}
                      <button className="px-2 py-1 text-sm border rounded" onClick={() => openLesson(course, l)}>Buka</button>
                    </div>
                  </li>
                ))}
              </ol>
            </div>
          </div>

          <div className="bg-white border rounded p-4">
            <h4 className="font-semibold mb-2">Ringkasan</h4>
            <p className="text-sm text-gray-600">Total pelajaran: {course.lessons.length}</p>
            <p className="mt-2 text-sm">Persentase selesai: {percentComplete(course)}%</p>
          </div>
        </div>
      </div>
    );
  }

  function LessonView({ course, lesson }) {
    if (!lesson || !course) return <div className="p-8">Pelajaran tidak ditemukan.</div>;

    const isDone = progress[course.id] && progress[course.id][lesson.id];

    return (
      <div className="max-w-5xl mx-auto px-4 py-8">
        <div className="bg-white border rounded p-6">
          <div className="flex justify-between items-start">
            <div>
              <h3 className="text-xl font-bold">{lesson.title}</h3>
              <p className="text-sm text-gray-500">Durasi: {lesson.duration}</p>
            </div>
            <div className="flex gap-2">
              <button className="px-3 py-1 border rounded text-sm" onClick={() => { setView({ name: "course" }); }}>Kembali</button>
              <button className={`px-3 py-1 rounded text-sm ${isDone ? "bg-gray-200" : "bg-green-600 text-white"}`} onClick={() => { if (!isDone) markLessonComplete(course.id, lesson.id); }}>{isDone ? "Telah Selesai" : "Tandai Selesai"}</button>
            </div>
          </div>

          <div className="mt-6">
            {lesson.content.type === "text" && (
              <div className="prose max-w-none text-sm text-gray-700">{lesson.content.text}</div>
            )}

            {lesson.content.type === "video" && (
              <div className="mt-4">
                <video controls className="w-full rounded" src={lesson.content.src} />
              </div>
            )}

            <div className="mt-6">
              <h4 className="font-semibold">Catatan</h4>
              <textarea className="w-full border rounded p-2 mt-2" placeholder="Catat insight penting..." />
            </div>
          </div>
        </div>
      </div>
    );
  }

  function ProfileView() {
    const completedCourses = courses.filter((c) => percentComplete(c) === 100);
    return (
      <div className="max-w-4xl mx-auto px-4 py-8">
        <div className="bg-white border rounded p-6">
          <h3 className="text-xl font-bold">Profil</h3>
          <div className="mt-4">
            <p className="text-sm">Nama: {user ? user.name : "Tamu"}</p>
            <p className="text-sm mt-2">Kursus selesai: {completedCourses.length}</p>
            <div className="mt-4">
              <h4 className="font-medium">Sertifikat</h4>
              {completedCourses.length ? (
                <ul className="mt-2 space-y-2">
                  {completedCourses.map((c) => (
                    <li key={c.id} className="flex justify-between items-center">
                      <span>{c.title}</span>
                      <button className="px-2 py-1 border rounded text-sm" onClick={() => downloadCertificate(c)}>Download</button>
                    </li>
                  ))}
                </ul>
              ) : (
                <p className="text-sm text-gray-500 mt-2">Belum ada kursus yang selesai.</p>
              )}
            </div>
          </div>
        </div>
      </div>
    );
  }

  // --- Main render ---
  return (
    <div className="min-h-screen bg-slate-50 text-slate-800">
      <Header />

      <main className="pt-6">
        {view.name === "catalog" && <Catalog />}
        {view.name === "course" && <CourseView course={selectedCourse} />}
        {view.name === "lesson" && <LessonView course={selectedCourse} lesson={selectedLesson} />}
        {view.name === "profile" && <ProfileView />}
      </main>

      <footer className="mt-12 py-8 text-center text-sm text-gray-500">
        © {new Date().getFullYear()} E-LearnMini — Built with ❤️
      </footer>
    </div>
  );
}

              
